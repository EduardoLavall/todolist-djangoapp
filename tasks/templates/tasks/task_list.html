{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}Task List{% endblock %}

{% block content %}
    <h1>Task List</h1>

    {% if no_lists %}
      <div class="alert alert-info mt-4">You have no task lists yet. <a href="{% url 'create_tasklist' %}" class="btn btn-sm btn-primary ms-2">Create your first list</a></div>
    {% else %}

    {% if list_error %}
      <div class="alert alert-danger">{{ list_error }}</div>
    {% endif %}

    <div class="d-flex align-items-center mb-3">
      <h3 class="me-3">Tasks in: <span class="text-primary">{{ current_tasklist.name }}{% if current_tasklist.user != request.user %} <span style='color:#888;font-size:90%;'>(Shared)</span>{% endif %}</span></h3>
      <div style="display: flex; align-items: center; gap: 12px;">
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="tasklistDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Switch List
          </button>
          <ul class="dropdown-menu" aria-labelledby="tasklistDropdown">
            {% for tl in user_tasklists %}
              <li>
                <a class="dropdown-item {% if current_tasklist and tl.id == current_tasklist.id %}active{% endif %}" href="/?list={{ tl.id }}">
                  {{ tl.name }}{% if tl.user != request.user %} <span style="color:#888;font-size:90%">(Shared)</span>{% endif %}
                </a>
              </li>
            {% endfor %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-success" href="{% url 'create_tasklist' %}">+ Create New List</a></li>
          </ul>
        </div>
        {% if current_tasklist.user == request.user %}
        <button class="btn btn-outline-primary ms-2" id="openShareModalBtn" type="button">Share List</button>
        {% endif %}
      </div>
    </div>
    <!-- Hidden element to store current tasklist ID for JavaScript -->
    <div data-current-tasklist-id="{{ current_tasklist.id }}" style="display: none;"></div>

<div class="page-controls">
    <div class="filter-controls">
        <label>Filter by status:</label>
        <div class="filter-buttons">
            <a href="{% url 'task_list' %}?list={{ current_tasklist.id }}&status=ongoing{% if current_sort %}&sort={{ current_sort }}{% endif %}" 
               class="filter-btn {% if current_status_filter == 'ongoing' or not current_status_filter %}active{% endif %}">
                Ongoing
            </a>
            <a href="{% url 'task_list' %}?list={{ current_tasklist.id }}&status=completed{% if current_sort %}&sort={{ current_sort }}{% endif %}" 
               class="filter-btn {% if current_status_filter == 'completed' %}active{% endif %}">
                Completed
            </a>
            <a href="{% url 'task_list' %}?list={{ current_tasklist.id }}&status=all{% if current_sort %}&sort={{ current_sort }}{% endif %}" 
               class="filter-btn {% if current_status_filter == 'all' %}active{% endif %}">
                All Tasks
            </a>
        </div>
    </div>
    <div class="sort-controls">
        <label for="sort-dropdown">Sort by:</label>
        <div class="custom-dropdown">
            <select id="sort-dropdown" class="sort-select">
                <option value="due_date" {% if current_sort == 'due_date' or not current_sort %}selected{% endif %}>Due Date</option>
                <option value="priority" {% if current_sort == 'priority' %}selected{% endif %}>Priority</option>
                <option value="status" {% if current_sort == 'status' %}selected{% endif %}>Status</option>
            </select>
            <span class="dropdown-arrow">â¬</span>
        </div>
    </div>
    <button class="add-task-btn" id="addTaskBtn">
        <span class="add-icon">+</span>
        <span class="add-text">Add Task</span>
    </button>
</div>
    
    {% if tasks %}
    <div class="table-container">
        <table class="task-table">
            <thead>
                <tr>
                    <th class="completed-header" style="width:48px; padding-right:0;">&nbsp;</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Due Date</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th class="actions-header" style="width:70px;">&nbsp;</th>
                </tr>
            </thead>
            <tbody>
        {% for task in tasks %}
                <tr class="task-row" id="task-{{ task.id }}" style="background-color:
                    {% if task.status == 'completed' %}#97F5E9
                    {% elif task.status == 'ongoing' %}#F2F3DB
                    {% endif %}
                ">
                    <td class="completed-cell">
                        <form method="post" class="completion-form">
                            {% csrf_token %}
                            <input type="hidden" name="task_id" value="{{ task.id }}">
                            <input type="hidden" name="action" value="toggle_completion">
                            {% if current_status_filter %}
                            <input type="hidden" name="status" value="{{ current_status_filter }}">
                            {% endif %}
                            {% if current_sort %}
                            <input type="hidden" name="sort" value="{{ current_sort }}">
                            {% endif %}
                            <input type="checkbox" class="rounded-checkbox" name="is_completed" value="1" {% if task.is_completed %}checked{% endif %} aria-label="Toggle completed">
                        </form>
                    </td>
                    <td>
                        <div class="display-mode" id="display-{{ task.id }}">
                            <strong>{{ task.title }}</strong>
                        </div>
                    </td>
                    <td>
                        <div class="display-mode" id="display-desc-{{ task.id }}">
                            {% if task.description %}{{ task.description }}{% else %}&ndash;{% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="display-mode" id="display-date-{{ task.id }}">
                            {{ task.due_date|date:"M j, Y g:i A" }}
                        </div>
                    </td>
                    <td>
                        <div class="display-mode" id="display-priority-{{ task.id }}">
                            {% if task.priority == 'high' %}ğŸ”´{% elif task.priority == 'medium' %}ğŸŸ¡{% else %}ğŸŸ¢{% endif %} {{ task.priority|title }}
                        </div>
                    </td>
                    <td>
                        <div class="display-mode" id="display-status-{{ task.id }}">
                            {{ task.status|title }}
                        </div>
                    </td>
                    <td class="actions-cell">
                        <div class="display-mode" id="display-actions-{{ task.id }}" style="display: flex; align-items: center; gap: 12px;">
                            <span class="action-icon edit-action" title="Edit" data-task-id="{{ task.id }}" data-task-title="{{ task.title|escapejs }}" data-task-description="{{ task.description|escapejs }}" data-task-due-date="{{ task.due_date|date:'Y-m-d\\TH:i' }}" data-task-priority="{{ task.priority }}" data-task-tasklist="{{ task.tasklist.id }}">âœ</span>
                            <span class="action-icon delete-action" title="Delete" data-task-id="{{ task.id }}" data-task-title="{{ task.title|escapejs }}">ğŸ—‘</span>
                        </div>
                    </td>
                </tr>
        {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p>No tasks available.</p>
    {% endif %}
    {% endif %}
{% endblock %}

{% block modal %}
<div id="addTaskModal" class="modal">
  <div class="modal-content">
    <form method="post" action="{% url 'create_task' %}" id="addTaskForm">
      {% csrf_token %}
      <h2 class="modal-title">Add New Task</h2>

      <div class="modal-field">
        <label for="title">Title</label>
        <input type="text" name="title" placeholder="e.g., Finish Django Project" value="{{ form.title.value|default_if_none:'' }}" required>
        {% if form.title.errors %}
          <div class="form-error">{{ form.title.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="modal-field">
        <label for="description">Description</label>
        <textarea name="description" placeholder="Add more details here...">{{ form.description.value|default_if_none:'' }}</textarea>
        {% if form.description.errors %}
          <div class="form-error">{{ form.description.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="modal-field">
        <label for="due_date">Due Date & Time</label>
        <input type="datetime-local" name="due_date" value="{{ form.due_date.value|default_if_none:''|date:'Y-m-d\\TH:i' }}" required>
        {% if form.due_date.errors %}
          <div class="form-error">{{ form.due_date.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="modal-field">
        <label for="priority">Priority</label>
        <select name="priority" required>
          <option value="" disabled {% if not form.priority.value %}selected{% endif %}>Select priority</option>
          <option value="high" {% if form.priority.value == 'high' %}selected{% endif %}>ğŸ”´ High</option>
          <option value="medium" {% if form.priority.value == 'medium' %}selected{% endif %}>ğŸŸ¡ Medium</option>
          <option value="low" {% if form.priority.value == 'low' %}selected{% endif %}>ğŸŸ¢ Low</option>
        </select>
        {% if form.priority.errors %}
          <div class="form-error">{{ form.priority.errors.0 }}</div>
        {% endif %}
      </div>

      <div class="modal-field">
        <label for="tasklist">Task List</label>
        {{ form.tasklist }}
        {% if form.tasklist.errors %}
          <div class="form-error">{{ form.tasklist.errors.0 }}</div>
        {% endif %}
      </div>

      <!-- Status is always 'ongoing' for new tasks -->
      <input type="hidden" name="status" value="ongoing">

      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">Create</button>
        <button type="button" class="btn btn-secondary" id="cancelAddTaskBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>
{{ block.super }}
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <p>Are you sure you want to delete this task?</p>
    <div id="deleteTaskTitle" style="font-weight: bold; margin-bottom: 16px;"></div>
    <input type="hidden" id="deleteTaskId" value="">
    <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
    <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
  </div>
</div>

<!-- Share List Modal -->
<div id="shareTasklistModal" class="modal">
  <div class="modal-content">
    <form method="post" action="{% url 'share_tasklist' %}" id="shareTasklistForm">
      {% csrf_token %}
      <h2 class="modal-title">Share Task List</h2>
      <p class="modal-description">Share "{{ current_tasklist.name }}" with another user by entering their username below.</p>
      
      <div class="modal-field">
        <label for="username">Username</label>
        <input type="text" name="username" id="username" placeholder="Enter username" required>
        <div id="share-error-message" class="form-error" style="display: none;"></div>
      </div>
      
      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">Share</button>
        <button type="button" class="btn btn-secondary" id="cancelShareTasklistBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>
<div id="editTaskModal" class="modal">
  <div class="modal-content">
    <form method="post" action="{% url 'task_list' %}" id="editTaskForm" data-task-id="">
      {% csrf_token %}
      <input type="hidden" name="task_id" id="edit-task-id">
      <input type="hidden" name="status" value="ongoing">
      {% if current_status_filter %}
      <input type="hidden" name="filter_status" value="{{ current_status_filter }}">
      {% endif %}
      {% if current_sort %}
      <input type="hidden" name="filter_sort" value="{{ current_sort }}">
      {% endif %}
      <h2 class="modal-title">Edit Task</h2>
      <div class="modal-field">
        <label for="edit-title">Title</label>
        <input type="text" name="title" id="edit-title" required>
      </div>
      <div class="modal-field">
        <label for="edit-description">Description</label>
        <textarea name="description" id="edit-description"></textarea>
      </div>
      <div class="modal-field">
        <label for="edit-due-date">Due Date & Time</label>
        <input type="datetime-local" name="due_date" id="edit-due-date" required>
      </div>
      <div class="modal-field">
        <label for="edit-priority">Priority</label>
        <select name="priority" id="edit-priority" required>
          <option value="" disabled>Select priority</option>
          <option value="high">ğŸ”´ High</option>
          <option value="medium">ğŸŸ¡ Medium</option>
          <option value="low">ğŸŸ¢ Low</option>
        </select>
      </div>
      <div class="modal-field">
        <label for="edit-tasklist">Task List</label>
        <select name="tasklist" id="edit-tasklist" required>
          <option value="" disabled>Select a list</option>
          {% for tasklist in form.tasklist.field.queryset %}
            <option value="{{ tasklist.id }}">{{ tasklist.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-buttons">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" id="cancelEditTaskBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>


{% endblock %}
 